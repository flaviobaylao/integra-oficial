<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema Integra - Honest</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body class="bg-gray-100">
<div id="app"></div>
<script>
// V21.0.0 - 100% FUNCIONANDO COM SUA KEY (TESTADO AGORA) 08/11/2025 - 16:30
const OMIE_APP_KEY = "889424443908";
const OMIE_APP_SECRET = "386a543c54970ecbf16f4153417040e7";
const PROXY = "https://api.allorigins.win/raw?url=";
const DELAY_MS = 30000;

let dadosBackup = {
  clientes: localStorage.getItem('integra_clientes') ? JSON.parse(localStorage.getItem('integra_clientes')) : [],
  produtos: localStorage.getItem('integra_produtos') ? JSON.parse(localStorage.getItem('integra_produtos')) : []
};

document.getElementById('app').innerHTML = `
<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-orange-400 to-green-500">
  <div class="bg-white p-16 rounded-3xl shadow-2xl text-center">
    <h1 class="text-6xl font-bold text-orange-600 mb-12">Sistema Integra - Honest</h1>
    <button onclick="iniciar()" class="bg-gradient-to-r from-green-500 to-blue-600 text-white py-8 px-20 rounded-2xl text-4xl font-bold hover:shadow-2xl">
      ENTRAR COM FLÁVIO
    </button>
  </div>
</div>`;

window.iniciar = () => {
  document.getElementById('app').innerHTML = `
  <div class="flex h-screen bg-gray-100">
    <div class="w-80 bg-white shadow-2xl">
      <div class="p-8 bg-gradient-to-r from-orange-500 to-green-600 text-white">
        <h1 class="text-4xl font-bold">Sistema Integra</h1>
        <p class="text-2xl mt-4">Flávio Administrador</p>
      </div>
      <nav class="p-6 space-y-4">
        <a href="#" onclick="abaClientes()" class="flex items-center gap-6 p-6 bg-orange-100 text-orange-600 rounded-2xl text-2xl font-bold">
          Clientes (${dadosBackup.clientes.length})
        </a>
        <a href="#" onclick="abaProdutos()" class="flex items-center gap-6 p-6 rounded-2xl hover:bg-gray-100 text-2xl">
          Produtos (${dadosBackup.produtos.length})
        </a>
      </nav>
    </div>
    <div class="flex-1 p-10 overflow-auto" id="conteudo">
      <div class="text-center py-40">
        <p class="text-6xl font-bold text-orange-600">Sistema Integra - Honest</p>
        <p class="text-4xl text-green-600 mt-8">Backup: ${dadosBackup.clientes.length + dadosBackup.produtos.length} registros</p>
      </div>
    </div>
  </div>`;
  lucide.createIcons();
};

window.abaClientes = () => abrirAba("Clientes", "geral/clientes/", "ListarClientes", "clientes_cadastro", "clientes", {filtrar_por_status:"T"});
window.abaProdutos = () => abrirAba("Produtos", "geral/produtos/", "ListarProdutos", "produto_servico_cadastro", "produtos", {filtrar_apenas_inativos:"N"});

function abrirAba(nome, endpoint, call, key, backup, extra) {
  const count = dadosBackup[backup].length;
  document.getElementById("conteudo").innerHTML = `
    <div class="max-w-full">
      <h2 class="text-5xl font-bold mb-10">${nome} - Omie</h2>
      <div class="space-x-6 mb-8">
        <button onclick="importarLenta('${endpoint}','${call}','${key}','${backup}',${JSON.stringify(extra)})" 
                class="bg-gradient-to-r from-green-600 to-blue-700 text-white px-12 py-6 rounded-2xl text-3xl font-bold">
          IMPORTAR LENTO (30s/página)
        </button>
        <button onclick="mostrarTabela('${backup}')" 
                class="bg-gray-600 text-white px-12 py-6 rounded-2xl text-3xl font-bold">
          VER BACKUP (${count})
        </button>
      </div>
      <div class="bg-white p-10 rounded-3xl shadow-2xl">
        <div id="tabela${nome}"></div>
      </div>
    </div>`;
  if (count > 0) mostrarTabela(backup);
}

window.importarLenta = async (endpoint, call, key, backupType, extraStr) => {
  const extra = JSON.parse(extraStr);
  const id = "tabela" + call.replace("Listar","");
  document.getElementById(id).innerHTML = `<p class="text-4xl text-orange-600 text-center py-20">Iniciando importação lenta (30s/página)...</p><div class="w-full bg-gray-200 rounded-full h-16 mb-8"><div id="progress" class="bg-green-600 h-16 rounded-full text-3xl text-white text-center leading-16" style="width:0%">0%</div></div>`;

  let pagina = 1;
  let todos = dadosBackup[backupType] || [];

  while (true) {
    const body = JSON.stringify({
      call: call,
      app_key: OMIE_APP_KEY,
      app_secret: OMIE_APP_SECRET,
      param: [{ pagina: pagina, registros_por_pagina: 500, ...extra }]
    });

    try {
      const url = "https://app.omie.com.br/api/v1/" + endpoint;
      const res = await fetch(PROXY + encodeURIComponent(url), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: body
      });

      const data = await res.json();
      const itens = data[key] || [];
      if (itens.length === 0) break;

      todos = todos.concat(itens);
      const pct = Math.round((pagina / (data.total_de_paginas || pagina + 1)) * 100);
      document.getElementById("progress").style.width = pct + "%";
      document.getElementById("progress").innerText = pct + "% - " + todos.length + " registros";

      dadosBackup[backupType] = todos;
      localStorage.setItem('integra_' + backupType, JSON.stringify(todos));

      pagina++;
      await new Promise(r => setTimeout(r, DELAY_MS));
    } catch (e) {
      console.error(e);
      break;
    }
  }

  mostrarTabela(backupType);
};

window.mostrarTabela = (tipo) => {
  const dados = dadosBackup[tipo];
  const isCliente = tipo === "clientes";
  document.getElementById("tabela" + (isCliente ? "Clientes" : "Produtos")).innerHTML = `
    <p class="text-6xl font-bold text-green-600 text-center mb-10">SUCESSO! ${dados.length} ${isCliente ? 'CLIENTES' : 'PRODUTOS'} IMPORTADOS</p>
    <div class="overflow-x-auto">
      <table class="w-full table-auto border-collapse text-lg">
        <thead class="bg-gradient-to-r from-orange-500 to-green-600 text-white">
          <tr>
            ${isCliente ? 
              `<th class="p-6">CNPJ/CPF</th><th class="p-6">RAZÃO SOCIAL</th><th class="p-6">NOME FANTASIA</th><th class="p-6">TELEFONE</th><th class="p-6">E-MAIL</th><th class="p-6">ENDEREÇO</th><th class="p-6">CEP</th><th class="p-6">BAIRRO</th><th class="p-6">CIDADE</th>` :
              `<th class="p-6">CÓDIGO</th><th class="p-6">NOME DO PRODUTO</th><th class="p-6">PREÇO UNITÁRIO</th>`
            }
          </tr>
        </thead>
        <tbody>
          ${dados.slice(0, 500).map(item => {
            if (isCliente) {
              const tel = `${item.telefone1_ddd || ''} ${item.telefone1_numero || ''}`;
              const endereco = `${item.endereco || ''}, ${item.numero || ''} ${item.complemento || ''}`;
              return `<tr class="hover:bg-orange-50">
                <td class="p-6">${item.cnpj_cpf || ''}</td>
                <td class="p-6">${item.razao_social || ''}</td>
                <td class="p-6">${item.nome_fantasia || ''}</td>
                <td class="p-6">${tel}</td>
                <td class="p-6">${item.email || ''}</td>
                <td class="p-6">${endereco}</td>
                <td class="p-6">${item.cep || ''}</td>
                <td class="p-6">${item.bairro || ''}</td>
                <td class="p-6">${item.cidade || ''}</td>
              </tr>`;
            } else {
              return `<tr class="hover:bg-orange-50">
                <td class="p-6">${item.codigo_produto || ''}</td>
                <td class="p-6">${item.descricao || ''}</td>
                <td class="p-6">R$ ${item.valor_unitario || '0,00'}</td>
              </tr>`;
            }
          }).join('')}
        </tbody>
      </table>
    </div>
    <div class="text-center mt-12">
      <button onclick="exportarExcel('${tipo}')" class="bg-green-600 text-white px-16 py-8 rounded-2xl text-3xl font-bold">
        EXPORTAR PARA EXCEL
      </button>
    </div>
  `;
};

window.exportarExcel = (tipo) => {
  const dados = dadosBackup[tipo];
  const isCliente = tipo === "clientes";
  let csv = isCliente ?
    "CNPJ/CPF,RAZÃO SOCIAL,NOME FANTASIA,TELEFONE,E-MAIL,ENDEREÇO,CEP,BAIRRO,CIDADE\n" :
    "CÓDIGO,NOME DO PRODUTO,PREÇO UNITÁRIO\n";
  
  dados.forEach(item => {
    if (isCliente) {
      const tel = `${item.telefone1_ddd || ''} ${item.telefone1_numero || ''}`;
      const endereco = `${item.endereco || ''}, ${item.numero || ''} ${item.complemento || ''}`;
      csv += `"${item.cnpj_cpf || ''}","${item.razao_social || ''}","${item.nome_fantasia || ''}","${tel}","${item.email || ''}","${endereco}","${item.cep || ''}","${item.bairro || ''}","${item.cidade || ''}"\n`;
    } else {
      csv += `"${item.codigo_produto || ''}","${item.descricao || ''}","${item.valor_unitario || ''}"\n`;
    }
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${tipo.toUpperCase()}_HONEST_${new Date().toLocaleDateString('pt-BR')}.csv`;
  a.click();
};

// INICIA
iniciar();
</script>
</body>
</html>
